<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ö–æ—Ç–µ–ª–æ–∫ –≤–∞—Ä–∏—Ç</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #FFF; margin: 20px; }
    h1 { color: #E5A30C; }
    img { max-width: 200px; margin: 10px; border: 1px solid #ddd; }
    #results { margin-top: 20px; text-align: left; max-width: 600px; margin: 0 auto; }
    #results h3 { color: #E5A30C; }
    button { padding: 10px 20px; background: #E5A30C; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
    button:hover { background: #d4930a; }
    .recipe { border: 1px solid #eee; padding: 10px; margin: 10px 0; border-radius: 5px; }
    .recipe img { width: 100px; height: auto; }
  </style>
  <!-- TensorFlow.js –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, ~4MB, –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ 5-10 —Å–µ–∫) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@latest"></script>
</head>
<body>
  <h1>–ö–æ—Ç–µ–ª–æ–∫ –≤–∞—Ä–∏—Ç: –†–µ—Ü–µ–ø—Ç—ã –ø–æ —Ñ–æ—Ç–æ üç≤</h1>
  <p>–í—ã–±–µ—Ä–∏ 1-3 —Ñ–æ—Ç–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ ‚Äî —è —Ä–∞—Å–ø–æ–∑–Ω–∞—é –∏ –ø—Ä–µ–¥–ª–æ–∂—É —Ä–µ—Ü–µ–ø—Ç—ã!</p>
  <input type="file" id="photoInput" accept="image/*" multiple>
  <br><br>
  <button onclick="processPhotos()">–û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–æ—Ç–æ</button>
  <div id="preview"></div>
  <div id="results"></div>

  <script>
    const photoInput = document.getElementById('photoInput');
    const preview = document.getElementById('preview');
    const results = document.getElementById('results');
    let mobilenetModel = null; // –ö—ç—à –º–æ–¥–µ–ª–∏ TF.js

    // Fallback –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã (–µ—Å–ª–∏ TF.js –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç)
    const fallbackIngredients = ['apple', 'chicken', 'carrot', 'potato', 'tomato']; // –ù–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º –¥–ª—è API

    photoInput.addEventListener('change', (e) => {
      preview.innerHTML = ''; // –û—á–∏—Å—Ç–∏ preview
      const files = Array.from(e.target.files);
      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = document.createElement('img');
          img.src = event.target.result;
          img.alt = file.name;
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });

    async function processPhotos() {
      results.innerHTML = '<h2>–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ –∏ —Ä–µ—Ü–µ–ø—Ç—ã:</h2><p>–ó–∞–≥—Ä—É–∂–∞—é –º–æ–¥–µ–ª—å... (–ø–µ—Ä–≤—ã–π —Ä–∞–∑ –ø–æ–¥–æ–∂–¥–∏—Ç–µ 5-10 —Å–µ–∫)</p>';
      const files = Array.from(photoInput.files);
      if (files.length === 0) { alert('–í—ã–±–µ—Ä–∏ —Ñ–æ—Ç–æ!'); return; }

      // –ó–∞–≥—Ä—É–∑–∏ –º–æ–¥–µ–ª—å TF.js –æ–¥–∏–Ω —Ä–∞–∑
      if (!mobilenetModel) {
        try {
          mobilenetModel = await mobilenet.load();
          results.innerHTML += '<p>–ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞! –†–∞—Å–ø–æ–∑–Ω–∞—é...</p>';
        } catch (err) {
          alert('–û—à–∏–±–∫–∞ –º–æ–¥–µ–ª–∏: ' + err.message + '. –ò—Å–ø–æ–ª—å–∑—É—é fallback.');
          mobilenetModel = null;
        }
      }

      const allIngredients = []; // –°–æ–±—Ä–∞—Ç—å –≤—Å–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –∏–∑ —Ñ–æ—Ç–æ
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        let ingredients = [];
        const dataUrl = await new Promise(resolve => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(file);
        });

        if (mobilenetModel) {
          // –†–µ–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Å TF.js
          const img = new Image();
          img.src = dataUrl;
          await new Promise(resolve => img.onload = resolve);
          const predictions = await mobilenetModel.classify(img, 3); // –¢–æ–ø-3
          ingredients = predictions.map(p => p.className.toLowerCase()).filter(name => 
            // –§–∏–ª—å—Ç—Ä –Ω–∞ "–µ–¥–∞" ‚Äî –¥–æ–±–∞–≤—å –±–æ–ª—å—à–µ –ø–æ –≤–∫—É—Å—É
            name.includes('apple') || name.includes('chicken') || name.includes('carrot') || 
            name.includes('potato') || name.includes('tomato') || name.includes('food') || name.includes('vegetable')
          );
        } else {
          // Fallback: —Ä–∞–Ω–¥–æ–º –∏–ª–∏ –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
          const fileName = file.name.toLowerCase();
          ingredients = fallbackIngredients[Math.floor(Math.random() * fallbackIngredients.length)];
          if (fileName.includes('apple')) ingredients = ['apple'];
          else if (fileName.includes('chicken')) ingredients = ['chicken'];
          // –î–æ–±–∞–≤—å –±–æ–ª—å—à–µ if
        }

        if (ingredients.length === 0) ingredients = ['carrot']; // –î–µ—Ñ–æ–ª—Ç
        allIngredients.push(...ingredients);
        results.innerHTML += `<p><strong>–§–æ—Ç–æ ${i+1} (${file.name}):</strong> ${ingredients.join(', ')}</p>`;
      }

      // –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –¥–ª—è API
      const uniqueIngs = [...new Set(allIngredients)].join(',');
      results.innerHTML += `<p>–ò—â—É —Ä–µ—Ü–µ–ø—Ç—ã –¥–ª—è: ${uniqueIngs}</p>`;

      // –ü–æ–ª—É—á–∏ —Ä–µ—Ü–µ–ø—Ç—ã –æ—Ç Spoonacular
      try {
        const recipes = await getRecipes(uniqueIngs);
        displayRecipes(recipes);
      } catch (err) {
        results.innerHTML += `<p style="color: red;">–û—à–∏–±–∫–∞ API: ${err.message}. –ü—Ä–æ–≤–µ—Ä—å –∫–ª—é—á –∏–ª–∏ –ª–∏–º–∏—Ç.</p>`;
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è Spoonacular API (—Ç–≤–æ–π –∫–ª—é—á –≤—Å—Ç–∞–≤–ª–µ–Ω)
    async function getRecipes(ingredients) {
      const apiKey = '832d7b901105446c943ec692fae2aad5'; // –¢–í–û–ô –ö–õ–Æ–ß ‚Äî –£–î–ê–õ–ò –ò–ó –ö–û–î–ê –ü–û–°–õ–ï –¢–ï–°–¢–ê!
      const url = `https://api.spoonacular.com/recipes/findByIngredients?ingredients=${encodeURIComponent(ingredients)}&number=3&ranking=2&apiKey=${apiKey}`;
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      return await response.json();
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–æ–≤
    function displayRecipes(recipes) {
      let html = '<h3>–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã:</h3>';
      recipes.forEach(recipe => {
        html += `
          <div class="recipe">
            <h4>${recipe.title}</h4>
            <img src="${recipe.image}" alt="${recipe.title}" onerror="this.src='https://via.placeholder.com/100?text=–§–æ—Ç–æ'">
            <p><strong>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ:</strong> ${recipe.usedIngredients.map(ing => ing.name).join(', ')}</p>
            <p><strong>–í—Ä–µ–º—è:</strong> ${recipe.readyInMinutes} –º–∏–Ω | <strong>ID:</strong> ${recipe.id}</p>
            <a href="https://spoonacular.com/recipes/${recipe.id}-${recipe.title.toLowerCase().replace(/ /g, '-')}?apiKey=be91e1480d24206bbf771ee4blabe" target="_blank">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
          </div>
        `;
      });
      if (recipes.length === 0) html += '<p>–†–µ—Ü–µ–ø—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã ‚Äî –ø–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã!</p>';
      results.innerHTML += html;
    }

    // SW –¥–ª—è PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(err => console.error('SW:', err));
    }
  </script>
</body>
</html>

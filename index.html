<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ö–æ—Ç–µ–ª–æ–∫ –≤–∞—Ä–∏—Ç</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #FFF; margin: 20px; }
    h1 { color: #E5A30C; }
    img { max-width: 200px; margin: 10px; border: 1px solid #ddd; }
    #results { margin-top: 20px; text-align: left; max-width: 600px; margin: 0 auto; }
    #results h3 { color: #E5A30C; }
    button { padding: 10px 20px; background: #E5A30C; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
    button:hover { background: #d4930a; }
    .recipe { border: 1px solid #eee; padding: 10px; margin: 10px 0; border-radius: 5px; }
    .recipe img { width: 100px; height: auto; }
  </style>
</head>
<body>
  <h1>–ö–æ—Ç–µ–ª–æ–∫ –≤–∞—Ä–∏—Ç: –†–µ—Ü–µ–ø—Ç—ã –ø–æ —Ñ–æ—Ç–æ üç≤</h1>
  <p>–í—ã–±–µ—Ä–∏ 1-3 —Ñ–æ—Ç–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ ‚Äî —è —Ä–∞—Å–ø–æ–∑–Ω–∞—é –∏ –ø—Ä–µ–¥–ª–æ–∂—É —Ä–µ—Ü–µ–ø—Ç—ã!</p>
  <input type="file" id="photoInput" accept="image/*" multiple>
  <br><br>
  <button onclick="processPhotos()">–û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–æ—Ç–æ</button>
  <div id="preview"></div>
  <div id="results"></div>

  <script>
    const photoInput = document.getElementById('photoInput');
    const preview = document.getElementById('preview');
    const results = document.getElementById('results');

    // Fallback –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã (–ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ –∏–ª–∏ —Ä–∞–Ω–¥–æ–º)
    const fallbackIngredients = ['apple', 'chicken', 'carrot', 'potato', 'tomato', 'cabbage'];

    // Fallback —Ä–µ—Ü–µ–ø—Ç—ã (–µ—Å–ª–∏ API —É–ø–∞–¥—ë—Ç)
    const fallbackRecipes = {
      'carrot': [{title: '–ú–æ—Ä–∫–æ–≤–Ω—ã–π —Å–∞–ª–∞—Ç', usedIngredients: [{name: 'carrot'}], readyInMinutes: 5, image: 'https://via.placeholder.com/100?text=–°–∞–ª–∞—Ç'}],
      'cabbage': [{title: '–ö–∞–ø—É—Å—Ç–Ω—ã–π —Å–∞–ª–∞—Ç', usedIngredients: [{name: 'cabbage'}], readyInMinutes: 10, image: 'https://via.placeholder.com/100?text=–°–∞–ª–∞—Ç'}],
      'vegetable': [{title: '–û–≤–æ—â–Ω–æ–π —Å—É–ø', usedIngredients: [{name: 'vegetable'}], readyInMinutes: 20, image: 'https://via.placeholder.com/100?text=–°—É–ø'}]
    };

    photoInput.addEventListener('change', (e) => {
      preview.innerHTML = '';
      const files = Array.from(e.target.files).slice(0, 3); // –õ–∏–º–∏—Ç 3
      files.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = document.createElement('img');
          img.src = event.target.result;
          img.alt = `–§–æ—Ç–æ ${index + 1}: ${file.name}`;
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });

    async function processPhotos() {
      results.innerHTML = '<h2>–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ –∏ —Ä–µ—Ü–µ–ø—Ç—ã:</h2><p>–û–±—Ä–∞–±–æ—Ç–∫–∞... (–±—ã—Å—Ç—Ä–æ, –±–µ–∑ –º–æ–¥–µ–ª–∏)</p>';
      const files = Array.from(photoInput.files).slice(0, 3);
      if (files.length === 0) { alert('–í—ã–±–µ—Ä–∏ —Ñ–æ—Ç–æ!'); return; }

      const allIngredients = [];
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        let ingredients = [];
        const fileName = file.name.toLowerCase();
        let fallback = fallbackIngredients[Math.floor(Math.random() * fallbackIngredients.length)];

        // –£–º–Ω—ã–π fallback –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
        if (fileName.includes('kapust') || fileName.includes('cabbage') || fileName.includes('lettuce')) fallback = 'cabbage';
        else if (fileName.includes('morkov') || fileName.includes('carrot')) fallback = 'carrot';
        else if (fileName.includes('apple') || fileName.includes('yabloko')) fallback = 'apple';
        else if (fileName.includes('chicken') || fileName.includes('kurica')) fallback = 'chicken';
        // –î–æ–±–∞–≤—å –±–æ–ª—å—à–µ –ø–æ –≤–∫—É—Å—É (tomato = 'tomato' etc.)

        ingredients = [fallback];
        allIngredients.push(...ingredients);
        results.innerHTML += `<p><strong>–§–æ—Ç–æ ${i+1} (${file.name}):</strong> ${ingredients.join(', ')}</p>`;
      }

      const uniqueIngs = [...new Set(allIngredients)].join(',');
      results.innerHTML += `<p>–ò—â—É —Ä–µ—Ü–µ–ø—Ç—ã –¥–ª—è: ${uniqueIngs}</p>`;

      try {
        const recipes = await getRecipes(uniqueIngs);
        displayRecipes(recipes);
      } catch (err) {
        results.innerHTML += `<p style="color: red;">–û—à–∏–±–∫–∞ API: ${err.message}. –ó–∞–ø–∞—Å–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã.</p>`;
        const fbRecipes = [];
        allIngredients.forEach(ing => {
          if (fallbackRecipes[ing]) fbRecipes.push(...fallbackRecipes[ing]);
        });
        displayRecipes(fbRecipes);
      }
    }

    async function getRecipes(ingredients) {
      const apiKey = '832d7b901105446c943ec692fae2aad5'; // –¢–≤–æ–π –Ω–æ–≤—ã–π –∫–ª—é—á ‚Äî —É–¥–∞–ª–∏ –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞!
      const url = `https://api.spoonacular.com/recipes/findByIngredients?ingredients=${encodeURIComponent(ingredients)}&number=3&ranking=2&apiKey=${apiKey}`;
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      return await response.json();
    }

    function displayRecipes(recipes) {
      let html = '<h3>–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã:</h3>';
      recipes.forEach(recipe => {
        html += `
          <div class="recipe">
            <h4>${recipe.title || '–ó–∞–ø–∞—Å–Ω–æ–π —Ä–µ—Ü–µ–ø—Ç'}</h4>
            <img src="${recipe.image || 'https://via.placeholder.com/100?text=–†–µ—Ü–µ–ø—Ç'}" alt="${recipe.title || '–†–µ—Ü–µ–ø—Ç'}" onerror="this.src='https://via.placeholder.com/100?text=–§–æ—Ç–æ'">
            <p><strong>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ:</strong> ${recipe.usedIngredients ? recipe.usedIngredients.map(ing => ing.name).join(', ') : '–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –∏–∑ —Ñ–æ—Ç–æ'}</p>
            <p><strong>–í—Ä–µ–º—è:</strong> ${recipe.readyInMinutes || 15} –º–∏–Ω</p>
            <a href="${recipe.id ? `https://spoonacular.com/recipes/${recipe.id}` : '#'}" target="_blank">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
          </div>
        `;
      });
      if (recipes.length === 0) html += '<p>–†–µ—Ü–µ–ø—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã ‚Äî –ø–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã!</p>';
      results.innerHTML += html;
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(err => console.error('SW:', err));
    }
  </script>
</body>
</html>

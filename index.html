<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ö–æ—Ç–µ–ª–æ–∫ –≤–∞—Ä–∏—Ç</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #FFF; margin: 20px; }
    h1 { color: #E5A30C; }
    img { max-width: 200px; margin: 10px; border: 1px solid #ddd; }
    #results { margin-top: 20px; text-align: left; max-width: 600px; margin: 0 auto; }
    #results h3 { color: #E5A30C; }
    button { padding: 10px 20px; background: #E5A30C; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
    button:hover { background: #d4930a; }
    .recipe { border: 1px solid #eee; padding: 10px; margin: 10px 0; border-radius: 5px; }
    .recipe img { width: 100px; height: auto; }
    a { color: #E5A30C; text-decoration: none; }
  </style>
</head>
<body>
  <h1>–ö–æ—Ç–µ–ª–æ–∫ –≤–∞—Ä–∏—Ç: –†–µ—Ü–µ–ø—Ç—ã –ø–æ —Ñ–æ—Ç–æ üç≤</h1>
  <p>–í—ã–±–µ—Ä–∏ 1-3 —Ñ–æ—Ç–æ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ ‚Äî —è —Ä–∞—Å–ø–æ–∑–Ω–∞—é –∏ –ø—Ä–µ–¥–ª–æ–∂—É —Ä–µ—Ü–µ–ø—Ç—ã!</p>
  <input type="file" id="photoInput" accept="image/*" multiple>
  <br><br>
  <button onclick="processPhotos()">–û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–æ—Ç–æ</button>
  <div id="preview"></div>
  <div id="results"></div>

  <script>
    const photoInput = document.getElementById('photoInput');
    const preview = document.getElementById('preview');
    const results = document.getElementById('results');

    // –í—Å—Ç–∞–≤—å –∫–ª—é—á–∏ Edamam –∑–¥–µ—Å—å!
    const appIdEdamam = '8d4fd98c'; // –ò–∑ My Apps
    const appKeyEdamam = '6fe04d68261acb8b799dbd091ca9f581';

    // Fallback –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã
    const fallbackIngredients = ['apple', 'chicken', 'carrot', 'potato', 'tomato', 'cabbage'];

    // Fallback —Ä–µ—Ü–µ–ø—Ç—ã
    const fallbackRecipes = {
      'carrot': [{title: '–ú–æ—Ä–∫–æ–≤–Ω—ã–π —Å–∞–ª–∞—Ç', usedIngredients: [{name: 'carrot'}], readyInMinutes: 5, image: 'https://via.placeholder.com/100?text=–°–∞–ª–∞—Ç', calories: '50'}],
      'cabbage': [{title: '–°–∞–ª–∞—Ç –∏–∑ –∫–∞–ø—É—Å—Ç—ã', usedIngredients: [{name: 'cabbage'}], readyInMinutes: 10, image: 'https://via.placeholder.com/100?text=–°–∞–ª–∞—Ç', calories: '30'}],
      'vegetable': [{title: '–û–≤–æ—â–Ω–æ–π —Å—É–ø', usedIngredients: [{name: 'vegetable'}], readyInMinutes: 20, image: 'https://via.placeholder.com/100?text=–°—É–ø', calories: '150'}]
    };

    photoInput.addEventListener('change', (e) => {
      preview.innerHTML = '';
      const files = Array.from(e.target.files).slice(0, 3);
      files.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = document.createElement('img');
          img.src = event.target.result;
          img.alt = `–§–æ—Ç–æ ${index + 1}: ${file.name}`;
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });

    async function processPhotos() {
      results.innerHTML = '<h2>–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ –∏ —Ä–µ—Ü–µ–ø—Ç—ã:</h2><p>–û–±—Ä–∞–±–æ—Ç–∫–∞...</p>';
      const files = Array.from(photoInput.files).slice(0, 3);
      if (files.length === 0) { alert('–í—ã–±–µ—Ä–∏ —Ñ–æ—Ç–æ!'); return; }

      const allIngredients = [];
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        let ingredients = [];
        const fileName = file.name.toLowerCase();
        let fallback = fallbackIngredients[Math.floor(Math.random() * fallbackIngredients.length)];

        // Fallback –ø–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
        if (fileName.includes('kapust') || fileName.includes('cabbage')) fallback = 'cabbage';
        else if (fileName.includes('morkov') || fileName.includes('carrot')) fallback = 'carrot';
        else if (fileName.includes('yablok') || fileName.includes('apple')) fallback = 'apple';
        // –î–æ–±–∞–≤—å –±–æ–ª—å—à–µ

        ingredients = [fallback];
        allIngredients.push(...ingredients);
        results.innerHTML += `<p><strong>–§–æ—Ç–æ ${i+1} (${file.name}):</strong> ${ingredients.join(', ')}</p>`;
      }

      const uniqueIngs = [...new Set(allIngredients)].join(' ');
      results.innerHTML += `<p>–ò—â—É —Ä–µ—Ü–µ–ø—Ç—ã –¥–ª—è: ${uniqueIngs}</p>`;

      try {
        const recipes = await getRecipesEdamam(uniqueIngs);
        displayRecipes(recipes);
      } catch (err) {
        results.innerHTML += `<p style="color: red;">–û—à–∏–±–∫–∞ API: ${err.message}. –ó–∞–ø–∞—Å–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã.</p>`;
        const fbRecipes = [];
        allIngredients.forEach(ing => {
          if (fallbackRecipes[ing]) fbRecipes.push(...fallbackRecipes[ing]);
        });
        displayRecipes(fbRecipes);
      }
    }

    // Edamam: –ü–æ–∏—Å–∫ —Ä–µ—Ü–µ–ø—Ç–æ–≤
    async function getRecipesEdamam(ingredients) {
      if (appIdEdamam === '–¢–í–û–ô_APP_ID' || appKeyEdamam === '–¢–í–û–ô_APP_KEY') throw new Error('–í—Å—Ç–∞–≤—å –∫–ª—é—á–∏ Edamam');
      const url = `https://api.edamam.com/search?q=${encodeURIComponent(ingredients)}&app_id=${appIdEdamam}&app_key=${appKeyEdamam}&language=ru&to=3`;
      const response = await fetch(url);
      if (!response.ok) throw new Error('Edamam failed');
      const data = await response.json();
      return data.hits.map(hit => ({
        title: hit.recipe.label,
        image: hit.recipe.image,
        usedIngredients: hit.recipe.ingredients.slice(0, 3).map(ing => ({name: ing.text})),
        readyInMinutes: Math.round(hit.recipe.totalTime),
        calories: Math.round(hit.recipe.calories),
        id: hit.recipe.uri.split('_').pop()
      }));
    }

    function displayRecipes(recipes) {
      let html = '<h3>–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã:</h3>';
      recipes.forEach(recipe => {
        html += `
          <div class="recipe">
            <h4>${recipe.title || '–ó–∞–ø–∞—Å–Ω–æ–π —Ä–µ—Ü–µ–ø—Ç'}</h4>
            <img src="${recipe.image || 'https://via.placeholder.com/100?text=–†–µ—Ü–µ–ø—Ç'}" alt="${recipe.title}" onerror="this.src='https://via.placeholder.com/100?text=–§–æ—Ç–æ'">
            <p><strong>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:</strong> ${recipe.usedIngredients ? recipe.usedIngredients.map(ing => ing.name).join(', ') : '–ò–∑ —Ñ–æ—Ç–æ'}</p>
            <p><strong>–í—Ä–µ–º—è:</strong> ${recipe.readyInMinutes || 15} –º–∏–Ω | <strong>–ö–∞–ª–æ—Ä–∏–∏:</strong> ${recipe.calories || 'N/A'}</p>
            <a href="https://www.edamam.com/recipe/${recipe.id || '#'}" target="_blank">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
          </div>
        `;
      });
      if (recipes.length === 0) html += '<p>–†–µ—Ü–µ–ø—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã ‚Äî –ø–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã!</p>';
      results.innerHTML += html;
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(err => console.error('SW:', err));
    }
  </script>
</body>
</html>
